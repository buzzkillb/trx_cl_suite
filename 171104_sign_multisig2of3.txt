How to create the preimage to calculate a signature to spend from a P2SH output.

The P2SH transaction to spend from is from TX-Hash 267c6d75851efa18afb7edeb2da00c09afc575231db84b3277fc7ea3e174ecbd, output #2:

txid:    bdec74e1a37efc77324bb81d2375c5af090ca02debedb7af18fa1e85756d7c26
txindex: 01000000

The redeemScript corresponding to the output is:
512102930a11e92103daefde0d30b552f57d303e94a128e763ca9e69ff2006446934442103e74d2113dec75d75cde09a5b46297b1067e4b8b35e63c4c32b8cdbadfdffda1e2103067fcc39ee36d2417684511d1055fdc7d35e54911cb9de9ae30c988b666f675c2102dfb1c2a1c3456c8cb76714706dba77b3f4e7fe5afffc2503b121323a48ebbdcf54ae
(ripemd160(sha256(524104...8353ae) = 37fe3f20433380be4c742c978d3a9712c509656e, the scriptHash value from the output)

This is hence a 1-of-4 P2SH output. The one public key I try to use to spend this output with is the first one, namely:
02930a11e92103daefde0d30b552f57d303e94a128e763ca9e69ff200644693444

The new raw unsigned transaction spending this outpoint is:
0100000001bdec74e1a37efc77324bb81d2375c5af090ca02debedb7af18fa1e85756d7c260100000000ffffffff01c05d00000000000017a914de5462e6e84cdab5064220343b9331a3af6dbbf18700000000

nVersion: 01000000
TxIn:     01 bdec74e1a37efc77324bb81d2375c5af090ca02debedb7af18fa1e85756d7c26 01000000 00 ffffffff
TxOut:    01 c05d000000000000 17a914de5462e6e84cdab5064220343b9331a3af6dbbf187
Locktime: 00000000

Hence the preimage for the hash to calculate the signature is:
0100000001bdec74e1a37efc77324bb81d2375c5af090ca02debedb7af18fa1e85756d7c26010000008b512102930a11e92103daefde0d30b552f57d303e94a128e763ca9e69ff2006446934442103e74d2113dec75d75cde09a5b46297b1067e4b8b35e63c4c32b8cdbadfdffda1e2103067fcc39ee36d2417684511d1055fdc7d35e54911cb9de9ae30c988b666f675c2102dfb1c2a1c3456c8cb76714706dba77b3f4e7fe5afffc2503b121323a48ebbdcf54aeffffffff01c05d00000000000017a914de5462e6e84cdab5064220343b9331a3af6dbbf1870000000001000000

Double-SHA256 yields:
2bfbf441d056cd300de0a51c055da349beecfc6ae0d215590b662c5e1da81d79

This hash-value signed using the private key corresponding to the first public key gives:
304402204887a352b503da6f212c09ed7e973384d7660f62d2319a15b968252012d134810220695130bc101f44348203c51a50e46f37ed4bc5622795f5dfbddef2affb27e2a8

So the transaction to spend becomes:
0100000001bdec74e1a37efc77324bb81d2375c5af090ca02debedb7af18fa1e85756d7c2601000000d547304402204887a352b503da6f212c09ed7e973384d7660f62d2319a15b968252012d134810220695130bc101f44348203c51a50e46f37ed4bc5622795f5dfbddef2affb27e2a8014c8b512102930a11e92103daefde0d30b552f57d303e94a128e763ca9e69ff2006446934442103e74d2113dec75d75cde09a5b46297b1067e4b8b35e63c4c32b8cdbadfdffda1e2103067fcc39ee36d2417684511d1055fdc7d35e54911cb9de9ae30c988b666f675c2102dfb1c2a1c3456c8cb76714706dba77b3f4e7fe5afffc2503b121323a48ebbdcf54aeffffffff01c05d00000000000017a914de5462e6e84cdab5064220343b9331a3af6dbbf18700000000

nVersion:       01000000
TxIn:           01 bdec74e1a37efc77324bb81d2375c5af090ca02debedb7af18fa1e85756d7c26 01000000
scriptSig_size: d5
Sig:            47 304402204887a352b503da6f212c09ed7e973384d7660f62d2319a15b968252012d134810220695130bc101f44348203c51a50e46f37ed4bc5622795f5dfbddef2affb27e2a801
redeemScript:   4c8b 512102930a11e92103daefde0d30b552f57d303e94a128e763ca9e69ff2006446934442103e74d2113dec75d75cde09a5b46297b1067e4b8b35e63c4c32b8cdbadfdffda1e2103067fcc39ee36d2417684511d1055fdc7d35e54911cb9de9ae30c988b666f675c2102dfb1c2a1c3456c8cb76714706dba77b3f4e7fe5afffc2503b121323a48ebbdcf54ae
Sequence:       ffffffff
TxOut:          01 c05d000000000000 17a914de5462e6e84cdab5064220343b9331a3af6dbbf187
Locktime:       00000000

Submitting this transaction yields the error:
Error #-26: 16: mandatory-script-verify-flag-failed (Operation not valid with the current stack size), code=-26)

==== and this ! ====

After checking it for a hundred times I saw that in the pastebin I uploaded I forgot to add the OP_0 (0x00) in the front of the scriptSig. After adding this it works! Thanks a lot for pointing out that the redeemScript is used in the preimage! This was the final signed transaction: â€“ Inaki Oct 10 at 15:00 
  	
0100000001bdec74e1a37efc77324bb81d2375c5af090ca02debedb7af18fa1e85756d7c2601000000d60047304402204887a352b503da6f212c09ed7e973384d7660f62d2319a15b968252012d134810220695130bc101f44348203c51a50e46f37ed4bc5622795f5dfbddef2affb27e2a8014c8b512102930a11e92103daefde0d30b552f57d303e94a128e763ca9e69ff2006446934442103e74d2113dec75d75cde09a5b46297b1067e4b8b35e63c4c32b8cdbadfdffda1e2103067fcc39ee36d2417684511d1055fdc7d35e54911cb9de9ae30c988b666f675c2102dfb1c2a1c3456c8cb76714706dba77b3f4e7fe5afffc2503b121323a48ebbdcf54aeffffffff01c05d00000000000017a914de5462e6e84cdab5064220343b9331a3af6dbbf18700000000

================================================

https://bitcoin.stackexchange.com/questions/35799/how-to-find-z-value-of-multisig-transaction/35802#35802

for example this transaction: http://2coin.org/txinfo.aspx?txid=6c3dc603da32bba3f56f2b33053aaf0f0f17322386c0c6846786bffe49f6ef22&cur=BTC

{
  "rawtx": "0100000003fdb1fe0b4506f8d412f8498a0d747701bc5ed8c009e779ee670c82361c1d1dd501000000da00473044022025332b6dabf11e493fbc62c93e7302c48666512e1cf88157c26176f4af6d064702201ee7ec25d0917244e514c402e8751f112dfd1bef2b22ec5e496fbafabb52bf0101483045022100fa1f17bf59bee0ac33ae5f682711c5471c73a4aeb898aee218478289a4c7aa6e02207b40dfeae3fa4a50dc147bd42be40370d76a35d72c0b27b27c4ba2439a565fb90147522102cebf6ab580948d146b7cc771d8e646974349d3d7b11f3e03287d0997a477d3b921037ba651485b7a2cb222191eb64a55926e62bbabfe9b5ed2a9488aad547b20428252aeffffffffa614d26f1878078a00a3c296085576cd7e6361234ea82c865681041fcfdacea801000000d900473044021f0efe211b1ad84bbfea1be567aaab6b6767ef38c7ef464faec0e4dd233ced31022100cecae44897214d5c72caa7a2f2209f6930e6c2cd774fc7964bbde3dcda8713280147304402200b610566cfb0795d42eb0fa81b5ed0049720da74ffa672fe41a3575a8d01554f02201ac6c998e7a0fd1b5436895b9e3c036f282877205fe1cd6eda36d142b31fe9890147522102cebf6ab580948d146b7cc771d8e646974349d3d7b11f3e03287d0997a477d3b921037ba651485b7a2cb222191eb64a55926e62bbabfe9b5ed2a9488aad547b20428252aeffffffffd064d2f9cf9e5196a9d81dd87718c9cfbec97f3ccac7164946d956421597c7f101000000da0048304502203c67f2a1c8d7c460b80efb40c2ce4e6735166c0ad1ecf5b5ed04cb4b86f2883e0221009906df06f2ab889c5460475a2b41d8c3d12a3ea781f540af7c18a4ef30925b7801473044022052477b7949b3909bcce38913dc7f91b691948cbd524e9f083e59586090d62e4a0220046b7ef6e2c634a9fb814dd0f2df8df3257db1caef6caf3c09dc88125911805b0147522102cebf6ab580948d146b7cc771d8e646974349d3d7b11f3e03287d0997a477d3b921037ba651485b7a2cb222191eb64a55926e62bbabfe9b5ed2a9488aad547b20428252aeffffffff01e0687046000000001976a9142c76e6fdd1a81c902afa62e78ec71435708d9d9d88ac00000000"
}
{
  "txid": "6c3dc603da32bba3f56f2b33053aaf0f0f17322386c0c6846786bffe49f6ef22",
  "version": 1,
  "locktime": 0,
  "vin": [
    {
      "txid": "d51d1d1c36820c67ee79e709c0d85ebc0177740d8a49f812d4f806450bfeb1fd",
      "vout": 1,
      "scriptSig": {
        "asm": "0 3044022025332b6dabf11e493fbc62c93e7302c48666512e1cf88157c26176f4af6d064702201ee7ec25d0917244e514c402e8751f112dfd1bef2b22ec5e496fbafabb52bf01[ALL] 3045022100fa1f17bf59bee0ac33ae5f682711c5471c73a4aeb898aee218478289a4c7aa6e02207b40dfeae3fa4a50dc147bd42be40370d76a35d72c0b27b27c4ba2439a565fb9[ALL] 522102cebf6ab580948d146b7cc771d8e646974349d3d7b11f3e03287d0997a477d3b921037ba651485b7a2cb222191eb64a55926e62bbabfe9b5ed2a9488aad547b20428252ae",
        "hex": "00473044022025332b6dabf11e493fbc62c93e7302c48666512e1cf88157c26176f4af6d064702201ee7ec25d0917244e514c402e8751f112dfd1bef2b22ec5e496fbafabb52bf0101483045022100fa1f17bf59bee0ac33ae5f682711c5471c73a4aeb898aee218478289a4c7aa6e02207b40dfeae3fa4a50dc147bd42be40370d76a35d72c0b27b27c4ba2439a565fb90147522102cebf6ab580948d146b7cc771d8e646974349d3d7b11f3e03287d0997a477d3b921037ba651485b7a2cb222191eb64a55926e62bbabfe9b5ed2a9488aad547b20428252ae"
      },
      "sequence": 4294967295,
      "n": 0,
      "addr": "3MfN5to5K5be2RupWE8rjJHQ6V9L8ypWeh",
      "valueSat": 28477922,
      "value": 0.28477922,
      "doubleSpentTxID": null,
      "sigR": "[25332b6dabf11e493fbc62c93e7302c48666512e1cf88157c26176f4af6d0647, 00fa1f17bf59bee0ac33ae5f682711c5471c73a4aeb898aee218478289a4c7aa6e]",
      "sigS": "[1ee7ec25d0917244e514c402e8751f112dfd1bef2b22ec5e496fbafabb52bf01, 7b40dfeae3fa4a50dc147bd42be40370d76a35d72c0b27b27c4ba2439a565fb9]",
      "sigZ": "9c4b551f37f4b383af9216045d80b2fcd4ed57bddca8df388ec29601cbd2a4f1"
    },
    {
      "txid": "a8cedacf1f048156862ca84e2361637ecd76550896c2a3008a0778186fd214a6",
      "vout": 1,
      "scriptSig": {
        "asm": "0 3044021f0efe211b1ad84bbfea1be567aaab6b6767ef38c7ef464faec0e4dd233ced31022100cecae44897214d5c72caa7a2f2209f6930e6c2cd774fc7964bbde3dcda871328[ALL] 304402200b610566cfb0795d42eb0fa81b5ed0049720da74ffa672fe41a3575a8d01554f02201ac6c998e7a0fd1b5436895b9e3c036f282877205fe1cd6eda36d142b31fe989[ALL] 522102cebf6ab580948d146b7cc771d8e646974349d3d7b11f3e03287d0997a477d3b921037ba651485b7a2cb222191eb64a55926e62bbabfe9b5ed2a9488aad547b20428252ae",
        "hex": "00473044021f0efe211b1ad84bbfea1be567aaab6b6767ef38c7ef464faec0e4dd233ced31022100cecae44897214d5c72caa7a2f2209f6930e6c2cd774fc7964bbde3dcda8713280147304402200b610566cfb0795d42eb0fa81b5ed0049720da74ffa672fe41a3575a8d01554f02201ac6c998e7a0fd1b5436895b9e3c036f282877205fe1cd6eda36d142b31fe9890147522102cebf6ab580948d146b7cc771d8e646974349d3d7b11f3e03287d0997a477d3b921037ba651485b7a2cb222191eb64a55926e62bbabfe9b5ed2a9488aad547b20428252ae"
      },
      "sequence": 4294967295,
      "n": 1,
      "addr": "3MfN5to5K5be2RupWE8rjJHQ6V9L8ypWeh",
      "valueSat": 740384136,
      "value": 7.40384136,
      "doubleSpentTxID": null,
      "sigR": "[0efe211b1ad84bbfea1be567aaab6b6767ef38c7ef464faec0e4dd233ced31, 0b610566cfb0795d42eb0fa81b5ed0049720da74ffa672fe41a3575a8d01554f]",
      "sigS": "[00cecae44897214d5c72caa7a2f2209f6930e6c2cd774fc7964bbde3dcda871328, 1ac6c998e7a0fd1b5436895b9e3c036f282877205fe1cd6eda36d142b31fe989]",
      "sigZ": "ed00e8901618c5a9bc4fb9f18734bb11a43b6a2f2798ff631b5f960e95f7e74e"
    },
    {
      "txid": "f1c797154256d9464916c7ca3c7fc9becfc91877d81dd8a996519ecff9d264d0",
      "vout": 1,
      "scriptSig": {
        "asm": "0 304502203c67f2a1c8d7c460b80efb40c2ce4e6735166c0ad1ecf5b5ed04cb4b86f2883e0221009906df06f2ab889c5460475a2b41d8c3d12a3ea781f540af7c18a4ef30925b78[ALL] 3044022052477b7949b3909bcce38913dc7f91b691948cbd524e9f083e59586090d62e4a0220046b7ef6e2c634a9fb814dd0f2df8df3257db1caef6caf3c09dc88125911805b[ALL] 522102cebf6ab580948d146b7cc771d8e646974349d3d7b11f3e03287d0997a477d3b921037ba651485b7a2cb222191eb64a55926e62bbabfe9b5ed2a9488aad547b20428252ae",
        "hex": "0048304502203c67f2a1c8d7c460b80efb40c2ce4e6735166c0ad1ecf5b5ed04cb4b86f2883e0221009906df06f2ab889c5460475a2b41d8c3d12a3ea781f540af7c18a4ef30925b7801473044022052477b7949b3909bcce38913dc7f91b691948cbd524e9f083e59586090d62e4a0220046b7ef6e2c634a9fb814dd0f2df8df3257db1caef6caf3c09dc88125911805b0147522102cebf6ab580948d146b7cc771d8e646974349d3d7b11f3e03287d0997a477d3b921037ba651485b7a2cb222191eb64a55926e62bbabfe9b5ed2a9488aad547b20428252ae"
      },
      "sequence": 4294967295,
      "n": 2,
      "addr": "3MfN5to5K5be2RupWE8rjJHQ6V9L8ypWeh",
      "valueSat": 412911338,
      "value": 4.12911338,
      "doubleSpentTxID": null,
      "sigR": "[3c67f2a1c8d7c460b80efb40c2ce4e6735166c0ad1ecf5b5ed04cb4b86f2883e, 52477b7949b3909bcce38913dc7f91b691948cbd524e9f083e59586090d62e4a]",
      "sigS": "[009906df06f2ab889c5460475a2b41d8c3d12a3ea781f540af7c18a4ef30925b78, 046b7ef6e2c634a9fb814dd0f2df8df3257db1caef6caf3c09dc88125911805b]",
      "sigZ": "cb58f6ea759d32c3e1683b8ba070c3c1a3fc5d773cda532e075d3540742685d8"
    }
  ],
  "vout": [
    {
      "value": "11.81772000",
      "n": 0,
      "scriptPubKey": {
        "hex": "76a9142c76e6fdd1a81c902afa62e78ec71435708d9d9d88ac",
        "asm": "OP_DUP OP_HASH160 2c76e6fdd1a81c902afa62e78ec71435708d9d9d OP_EQUALVERIFY OP_CHECKSIG",
        "addresses": [
          "1547AvEpxff6A63yU9UGXwC8GMDKQVeVZP"
        ],
        "type": "pubkeyhash"
      },
      "spentTxId": "af4e3b3a8f5ce3c41a3047ab3db6eebe6cdec42f232f7fa92505d747bf362b2a",
      "spentIndex": 0,
      "spentHeight": 339154
    }
  ],
  "blockhash": "000000000000000018199c6f1b25cdc751425631f8dcf90fb963e3fdec572e6f",
  "blockheight": 339135,
  "confirmations": 146311,
  "time": 1421368075,
  "blocktime": 1421368075,
  "valueOut": 11.81772,
  "size": 820,
  "valueIn": 11.81773396,
  "fees": 0.00001396
}

Note that for each input, the actual hash to be signed is going to be different. Namely, you will need to fill in the redeem script for that input only and nulls for every other input. To illustrate, let's figure out what you need to sign for the very first input.

Transaction version: 01000000
Number of inputs: 03
Tx input #1 hash: fdb1fe0b4506f8d412f8498a0d747701bc5ed8c009e779ee670c82361c1d1dd5
Tx input #1 index: 01000000
Tx input #1 redeem script length: 47 (71 bytes)
Tx input #1 redeem script: 522102cebf6ab580948d146b7cc771d8e646974349d3d7b11f3e03287d0997a477d3b921037ba651485b7a2cb222191eb64a55926e62bbabfe9b5ed2a9488aad547b20428252ae
Tx input #1 sequence: ffffffff
Tx input #2 hash: a614d26f1878078a00a3c296085576cd7e6361234ea82c865681041fcfdacea8
Tx input #2 index: 01000000
Tx input #2 redeem script length: 00 (nothing)
Tx input #2 sequence: ffffffff
Tx input #3 hash: d064d2f9cf9e5196a9d81dd87718c9cfbec97f3ccac7164946d956421597c7f1
Tx input #3 index: 01000000
Tx input #3 redeem script length: 00 (nothing)
Tx input #3 sequence: ffffffff
Number of outputs: 01000000
Amount being sent to the first (and only) output: e068704600000000
Output script length: 19
Output script: 76a9142c76e6fdd1a81c902afa62e78ec71435708d9d9d88ac
Lock time field: 00000000
SIGHASH_ALL: 01000000
Now, if you double-sha256 these bytes you get:

9c4b551f37f4b383af9216045d80b2fcd4ed57bddca8df388ec29601cbd2a4f1

And indeed when you check against the embedded signature of that transaction, you can see that that is indeed the hash that was signed.

